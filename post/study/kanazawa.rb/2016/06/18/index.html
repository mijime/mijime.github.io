<!DOCTYPE html><html lang="ja"><head><link rel="icon" href="/favicon.png"/><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><title> kanazawa.rb meetup 46に参加した | My snippets</title><meta name="next-head-count" content="3"/><link rel="preload" href="/_next/static/css/b64f9e8251e1dbe60595.css" as="style"/><link rel="stylesheet" href="/_next/static/css/b64f9e8251e1dbe60595.css" data-n-g=""/><link rel="preload" href="/_next/static/css/c145aca0861697fc02d3.css" as="style"/><link rel="stylesheet" href="/_next/static/css/c145aca0861697fc02d3.css" data-n-g=""/><noscript data-n-css=""></noscript><link rel="preload" href="/_next/static/chunks/main-815f6ece7160a05ea49c.js" as="script"/><link rel="preload" href="/_next/static/chunks/webpack-95c2b224bccf352ee870.js" as="script"/><link rel="preload" href="/_next/static/chunks/framework.daa7383ad2ab2e6757c1.js" as="script"/><link rel="preload" href="/_next/static/chunks/4a18a4e3.6de1b3e704db25d01376.js" as="script"/><link rel="preload" href="/_next/static/chunks/commons.88fee2b8ea42b74e9a8c.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/_app-db71eca8c845b76e9c7d.js" as="script"/><link rel="preload" href="/_next/static/chunks/9606030d286e6a39d87242669141d380e2292a8c.0e253dff2c97da1d3433.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/post/study/kanazawa.rb/2016/06/18-5796aa437a6dbabf9c76.js" as="script"/></head><body><section class="hero is-dark is-medium is-bold"><div class="hero-body"><div class="container has-text-centered"><h1 class="title"><a href="/">My snippets</a></h1></div></div></section><div class="container"><div class="column is-8 is-offset-2"><div id="__next"><div class="article card"><div class="card-content"><div class="article-title"><div class="has-text-centered"><p class="title"> kanazawa.rb meetup 46に参加した</p><div class="tags level-item has-addons"><span class="tag is-rounded is-info"><a href="/tag/development/1/">development</a></span><span class="tag is-rounded is-info"><a href="/tag/lambda/1/">lambda</a></span><span class="tag is-rounded is-info"><a href="/tag/kzrb/1/">kzrb</a></span><span class="tag is-rounded">2016-06-18T13:23:05+09:00</span></div></div></div><div class="content article-body pt-8"><h2>AWS Lambda を管理するツール Lamma やってみた</h2><p>Ruby で書かれた lammba というリポジトリが上がったので
ruby 勉強会に参加がてら触ってみた</p><h3><a href="https://github.com/ayemos/Lamma">lamma</a></h3><h3>作業リポジトリ</h3><p><a href="https://github.com/mijime/mijime.github.io/tree/content/source/study/kanazawa.rb/2016-06-18">source</a></p><h3>作業雑感</h3><p>シンプルな Lambda 管理ツール</p><h4>Pros</h4><ul><li>1 dir, 1 func なのでわかりやすいね</li><li>勝手に zip してくれるね</li><li>Ruby なので今後拡張しやすい、のかな？</li></ul><h4>Cons</h4><ul><li>nodejs, python2.7 のみ対応</li><li>消したりするのめんどくさそう ... まぁ関数だけだからいいんだけども ...</li><li>node_modules 入ってない？</li></ul><h3>作業ログ</h3><p>まずは環境作成</p><pre><code class="hljs language-ruby">source <span class="hljs-string">&quot;https://rubygems.org&quot;</span>

gem <span class="hljs-string">&quot;lamma&quot;</span></code></pre><pre><code>FROM ruby

COPY Gemfile /var/app/Gemfile
WORKDIR /var/app
RUN bundle install
</code></pre><pre><code>---
version: &#x27;2&#x27;
services:
  app:
    build: .
    command: sleep 3600
    environment:
      AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID}
      AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY}
    volumes:
      - ./scripts:/var/app/scripts
</code></pre><p>とりあえずインストールして実行してみる</p><p>AWS 関連の情報を渡して ...</p><pre><code>eval $(cat ~/.aws/credentials | awk -v FS=&quot; = &quot; &#x27;$1~/^aws/{print &quot;export&quot;,toupper($1)&quot;=&quot;$2}&#x27;)
</code></pre><p>関数を作成してみる</p><pre><code>lamma create scripts/my-function-1 --runtime python2.7

Creating function at directory ./scripts/my-function-1.
bundler: failed to load command: lamma (/usr/local/bundle/bin/lamma)
NoMethodError: undefined method `match&#x27; for nil:NilClass
Did you mean?  catch
/usr/local/bundle/gems/aws-sdk-core-2.3.14/lib/aws-sdk-core/endpoint_provider.rb:67:in `block in partition_matching_region&#x27;
/usr/local/bundle/gems/aws-sdk-core-2.3.14/lib/aws-sdk-core/endpoint_provider.rb:66:in `each&#x27;
/usr/local/bundle/gems/aws-sdk-core-2.3.14/lib/aws-sdk-core/endpoint_provider.rb:66:in `find&#x27;
/usr/local/bundle/gems/aws-sdk-core-2.3.14/lib/aws-sdk-core/endpoint_provider.rb:66:in `partition_matching_region&#x27;
...
</code></pre><p>うーん ... なぜに nil ...</p><p>AWS_REGION を渡す</p><pre><code class="hljs language-diff">diff --git a/source/study/kanazawa.rb/2016-06-18/docker-compose.yml b/source/study/kanazawa.rb/2016-06-18/docker-compose.yml
index e03b010..2784d3c 100644
<span class="hljs-comment">--- a/source/study/kanazawa.rb/2016-06-18/docker-compose.yml</span>
<span class="hljs-comment">+++ b/source/study/kanazawa.rb/2016-06-18/docker-compose.yml</span>
@@ -7,5 +7,6 @@ services:
     environment:
       AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID}
       AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY}
<span class="hljs-addition">+      AWS_REGION: ap-northeast-1</span>
     volumes:
       - ./scripts:/var/app/scripts</code></pre><pre><code>$ lamma create my-function --runtime python2.7

Creating function at directory ./my-function.
Done.
</code></pre><pre><code>$ tree .

my-function
  ├── lambda_function.py
  └── lamma.conf

1 directory, 2 files
</code></pre><p>まだこの時点で関数は作られていないみたい ... なんで AWS 認証求められたんだ</p><p>deploy してみる。</p><pre><code>$ lamma deploy test

Loading configuration.
Done.
bundler: failed to load command: lamma (/usr/local/bundle/bin/lamma)
Aws::Lambda::Errors::BadRequest:
/usr/local/bundle/gems/aws-sdk-core-2.3.14/lib/seahorse/client/plugins/raise_response_errors.rb:15:in `call&#x27;
/usr/local/bundle/gems/aws-sdk-core-2.3.14/lib/aws-sdk-core/plugins/param_converter.rb:20:in `call&#x27;
/usr/local/bundle/gems/aws-sdk-core-2.3.14/lib/seahorse/client/plugins/response_target.rb:21:in `call&#x27;
</code></pre><p>うーん ... ?</p><p>よくわからないので JS で作り直す</p><pre><code>$ lamma create my-function-js --runtime nodejs

Creating function at directory ./my-function-js.
Done.
</code></pre><pre><code>$ lamma deploy test

Loading configuration.
Done.
Function &#x27;my-function-js&#x27; doesn&#x27;t seem to be exists.
Do you want to create new function &#x27;my-function-js&#x27; ? (y/n) y
Creating function &#x27;my-function-js&#x27; ...
bundler: failed to load command: lamma (/usr/local/bundle/bin/lamma)
Errno::ENOENT: No such file or directory @ rb_sysopen - /tmp/d20160618-92-1fppw7/lambda.zip
  /usr/local/bundle/gems/lamma-0.1.1/lib/lamma/function.rb:57:in `initialize&#x27;
...
</code></pre><p>zip ...</p><pre><code class="hljs language-diff">diff --git a/source/study/kanazawa.rb/2016-06-18/Dockerfile b/source/study/kanazawa.rb/2016-06-18/Dockerfile
index f9e4aff..0595f36 100644
<span class="hljs-comment">--- a/source/study/kanazawa.rb/2016-06-18/Dockerfile</span>
<span class="hljs-comment">+++ b/source/study/kanazawa.rb/2016-06-18/Dockerfile</span>
@@ -3,3 +3,4 @@ FROM ruby
COPY Gemfile /var/app/Gemfile
WORKDIR /var/app
RUN bundle install
<span class="hljs-addition">+RUN apt-get update &amp;&amp; apt-get install -y zip</span></code></pre><pre><code>$ lamma deploy test

Loading configuration.
Done.
Function &#x27;my-function-js&#x27; doesn&#x27;t seem to be exists.
Do you want to create new function &#x27;my-function-js&#x27; ? (y/n) y
Creating function &#x27;my-function-js&#x27; ...
adding: lamma.conf (deflated 17%)
adding: index.js (deflated 45%)
ArgumentError occured. You might need to specify role arn you want to pass to your function via &#x27;lamma.conf&#x27; file or ENV[&#x27;AWS_LAMBDA_IAM_ROLE&#x27;].
Done.
</code></pre><p>ほむほむ ... あんましロールを書きたくないので env で</p><pre><code>export AWS_LAMBDA_IAM_ROLE=arn:aws:iam::000000000000:role/lambda_basic_execution
</code></pre><pre><code>$ lamma deploy test

Loading configuration.
Done.
Function &#x27;my-function-js&#x27; doesn&#x27;t seem to be exists.
Do you want to create new function &#x27;my-function-js&#x27; ? (y/n) y
Creating function &#x27;my-function-js&#x27; ...
adding: lamma.conf (deflated 17%)
adding: index.js (deflated 45%)
Done.
Setting aliases.
Done.
</code></pre><pre><code>$ lamma list-functions

my-function-js
</code></pre><p>できた。</p><h2>LT 感想</h2><h3>シェルチェックを使おう</h3><ul><li>文法がバラバラなので統一する</li><li>各環境でパッケージとして提供されている</li></ul><p>確かにシェルは動かすの簡単だけど、 他の環境で動かないことが多い ...</p><h3>shUnit2 を使おう</h3><ul><li>対応シェルも幅広い</li><li>ダウンロードするだけで使える！</li></ul><p>bats 派だけど、 msys でも早いなら乗り換えたいかも</p><h3>Dokku</h3><ul><li>Heroku like</li><li>前面に nginx があって、 コンテナにルーティング</li><li>heroku の build packs も利用できるので良い！</li><li>運用メンテナンスが気になるところ</li></ul><p>スケーリングしないとかで敬遠してたけども、 開発環境で利用するなら楽だよなぁ</p><p>だいぶバージョンアップされているとのことなので、触ってみたい</p><p>もっと利用されるという話なので、その話を聞いてからかな？</p><p>dokku-alt との違いもあとで調べておこう ...</p><h3>AWSSummit</h3><p>SIer が完全に淘汰されちゃう感じ</p><p>PaaS, SaaS の流行には全然触れてなかったので、 今回の話を機会に調べてみよう ...</p><h3>Iot</h3><p>書き込むのに結構ツールが必要なんですね ...</p><p>IOT 超絶敷居高い。</p></div></div></div></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{}},"page":"/post/study/kanazawa.rb/2016/06/18","query":{},"buildId":"7BKB7Lfp3UmqovJvkmS6v","nextExport":true,"autoExport":true,"isFallback":false}</script><script nomodule="" src="/_next/static/chunks/polyfills-186ec2ee1a82d7092f95.js"></script><script src="/_next/static/chunks/main-815f6ece7160a05ea49c.js" async=""></script><script src="/_next/static/chunks/webpack-95c2b224bccf352ee870.js" async=""></script><script src="/_next/static/chunks/framework.daa7383ad2ab2e6757c1.js" async=""></script><script src="/_next/static/chunks/4a18a4e3.6de1b3e704db25d01376.js" async=""></script><script src="/_next/static/chunks/commons.88fee2b8ea42b74e9a8c.js" async=""></script><script src="/_next/static/chunks/pages/_app-db71eca8c845b76e9c7d.js" async=""></script><script src="/_next/static/chunks/9606030d286e6a39d87242669141d380e2292a8c.0e253dff2c97da1d3433.js" async=""></script><script src="/_next/static/chunks/pages/post/study/kanazawa.rb/2016/06/18-5796aa437a6dbabf9c76.js" async=""></script><script src="/_next/static/7BKB7Lfp3UmqovJvkmS6v/_buildManifest.js" async=""></script><script src="/_next/static/7BKB7Lfp3UmqovJvkmS6v/_ssgManifest.js" async=""></script></body></html>