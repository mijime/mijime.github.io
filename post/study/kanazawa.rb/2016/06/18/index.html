<!DOCTYPE html><html lang="ja"><head><link rel="icon" href="/favicon.png"/><meta name="google-site-verification" content="7gVj5rzyozu0vYcQMLhIGr4g-WWyJn4R22RgeYqQdS0"/><script src="https://www.googletagmanager.com/gtag/js?id=UA-46554348-4"></script><script>
window.dataLayer = window.dataLayer || [];
window.gtag = function(){dataLayer.push(arguments);}
window.gtag('js', new Date());
window.gtag('config', 'UA-46554348-4', {page_path: window.location.pathname});
</script><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><title> kanazawa.rb meetup 46に参加した | My snippets</title><meta name="next-head-count" content="3"/><link rel="preload" href="/_next/static/css/441a871f60534772bea2.css" as="style"/><link rel="stylesheet" href="/_next/static/css/441a871f60534772bea2.css" data-n-g=""/><link rel="preload" href="/_next/static/css/6ce22e89cb319c340ee0.css" as="style"/><link rel="stylesheet" href="/_next/static/css/6ce22e89cb319c340ee0.css" data-n-p=""/><noscript data-n-css=""></noscript><link rel="preload" href="/_next/static/chunks/main-68ca09d5e091eab3c5ab.js" as="script"/><link rel="preload" href="/_next/static/chunks/webpack-50bee04d1dc61f8adf5b.js" as="script"/><link rel="preload" href="/_next/static/chunks/framework.d2ae4074d0a54d95f68e.js" as="script"/><link rel="preload" href="/_next/static/chunks/commons.7394d07e57118caf40be.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/_app-9ecc240cedbde30f7a8f.js" as="script"/><link rel="preload" href="/_next/static/chunks/8d28131037b551229a39f010c44923deddaa105c.90d52ab2c7071c6500e2.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/post/study/kanazawa.rb/2016/06/18-af5e6c7d11738578b77b.js" as="script"/></head><body><div id="__next"><div class="default_defaultLayout__3Vqq_"><section class="navbar-header_navbarHeader__2QEfN"><h3 class="navbar-header_navbarHeaderTitle__ucqZ4"><a href="/">My snippets</a></h3></section><div class="default_defaultLayoutContent__1-Dol"><div class="card_card__23baz"><h1 class="article-card_title__2q2Ue"><a href="/post/study/kanazawa.rb/2016/06/18/"> kanazawa.rb meetup 46に参加した</a></h1><div class="tag-list_tagList__JhjSf"><span class="tag_tag__35zkz tag-list_tagLink__1TsNW"><a href="/tag/development/posts/1/">development</a></span><span class="tag_tag__35zkz tag-list_tagLink__1TsNW"><a href="/tag/lambda/posts/1/">lambda</a></span><span class="tag_tag__35zkz tag-list_tagLink__1TsNW"><a href="/tag/kzrb/posts/1/">kzrb</a></span><span class="tag_tag__35zkz tag-list_tagDate__x9jrl">4 years ago</span></div><div class="article-card_content__pMn5H"><div class="prose post_prose__31ydD"><h2>AWS Lambda を管理するツール Lamma やってみた</h2><p>Ruby で書かれた lammba というリポジトリが上がったので
ruby 勉強会に参加がてら触ってみた</p><h3><a href="https://github.com/ayemos/Lamma">lamma</a></h3><h3>作業リポジトリ</h3><p><a href="https://github.com/mijime/mijime.github.io/tree/content/source/study/kanazawa.rb/2016-06-18">source</a></p><h3>作業雑感</h3><p>シンプルな Lambda 管理ツール</p><h4>Pros</h4><ul><li>1 dir, 1 func なのでわかりやすいね</li><li>勝手に zip してくれるね</li><li>Ruby なので今後拡張しやすい、のかな？</li></ul><h4>Cons</h4><ul><li>nodejs, python2.7 のみ対応</li><li>消したりするのめんどくさそう ... まぁ関数だけだからいいんだけども ...</li><li>node_modules 入ってない？</li></ul><h3>作業ログ</h3><p>まずは環境作成</p><pre><code class="hljs language-ruby">source <span class="hljs-string">&quot;https://rubygems.org&quot;</span>

gem <span class="hljs-string">&quot;lamma&quot;</span></code></pre><pre><code>FROM ruby

COPY Gemfile /var/app/Gemfile
WORKDIR /var/app
RUN bundle install
</code></pre><pre><code>---
version: &#x27;2&#x27;
services:
  app:
    build: .
    command: sleep 3600
    environment:
      AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID}
      AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY}
    volumes:
      - ./scripts:/var/app/scripts
</code></pre><p>とりあえずインストールして実行してみる</p><p>AWS 関連の情報を渡して ...</p><pre><code>eval $(cat ~/.aws/credentials | awk -v FS=&quot; = &quot; &#x27;$1~/^aws/{print &quot;export&quot;,toupper($1)&quot;=&quot;$2}&#x27;)
</code></pre><p>関数を作成してみる</p><pre><code>lamma create scripts/my-function-1 --runtime python2.7

Creating function at directory ./scripts/my-function-1.
bundler: failed to load command: lamma (/usr/local/bundle/bin/lamma)
NoMethodError: undefined method `match&#x27; for nil:NilClass
Did you mean?  catch
/usr/local/bundle/gems/aws-sdk-core-2.3.14/lib/aws-sdk-core/endpoint_provider.rb:67:in `block in partition_matching_region&#x27;
/usr/local/bundle/gems/aws-sdk-core-2.3.14/lib/aws-sdk-core/endpoint_provider.rb:66:in `each&#x27;
/usr/local/bundle/gems/aws-sdk-core-2.3.14/lib/aws-sdk-core/endpoint_provider.rb:66:in `find&#x27;
/usr/local/bundle/gems/aws-sdk-core-2.3.14/lib/aws-sdk-core/endpoint_provider.rb:66:in `partition_matching_region&#x27;
...
</code></pre><p>うーん ... なぜに nil ...</p><p>AWS_REGION を渡す</p><pre><code class="hljs language-diff"><span class="hljs-comment">diff --git a/source/study/kanazawa.rb/2016-06-18/docker-compose.yml b/source/study/kanazawa.rb/2016-06-18/docker-compose.yml</span>
<span class="hljs-comment">index e03b010..2784d3c 100644</span>
<span class="hljs-comment">--- a/source/study/kanazawa.rb/2016-06-18/docker-compose.yml</span>
<span class="hljs-comment">+++ b/source/study/kanazawa.rb/2016-06-18/docker-compose.yml</span>
<span class="hljs-meta">@@ -7,5 +7,6 @@</span> services:
     environment:
       AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID}
       AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY}
<span class="hljs-addition">+      AWS_REGION: ap-northeast-1</span>
     volumes:
       - ./scripts:/var/app/scripts</code></pre><pre><code>$ lamma create my-function --runtime python2.7

Creating function at directory ./my-function.
Done.
</code></pre><pre><code>$ tree .

my-function
  ├── lambda_function.py
  └── lamma.conf

1 directory, 2 files
</code></pre><p>まだこの時点で関数は作られていないみたい ... なんで AWS 認証求められたんだ</p><p>deploy してみる。</p><pre><code>$ lamma deploy test

Loading configuration.
Done.
bundler: failed to load command: lamma (/usr/local/bundle/bin/lamma)
Aws::Lambda::Errors::BadRequest:
/usr/local/bundle/gems/aws-sdk-core-2.3.14/lib/seahorse/client/plugins/raise_response_errors.rb:15:in `call&#x27;
/usr/local/bundle/gems/aws-sdk-core-2.3.14/lib/aws-sdk-core/plugins/param_converter.rb:20:in `call&#x27;
/usr/local/bundle/gems/aws-sdk-core-2.3.14/lib/seahorse/client/plugins/response_target.rb:21:in `call&#x27;
</code></pre><p>うーん ... ?</p><p>よくわからないので JS で作り直す</p><pre><code>$ lamma create my-function-js --runtime nodejs

Creating function at directory ./my-function-js.
Done.
</code></pre><pre><code>$ lamma deploy test

Loading configuration.
Done.
Function &#x27;my-function-js&#x27; doesn&#x27;t seem to be exists.
Do you want to create new function &#x27;my-function-js&#x27; ? (y/n) y
Creating function &#x27;my-function-js&#x27; ...
bundler: failed to load command: lamma (/usr/local/bundle/bin/lamma)
Errno::ENOENT: No such file or directory @ rb_sysopen - /tmp/d20160618-92-1fppw7/lambda.zip
  /usr/local/bundle/gems/lamma-0.1.1/lib/lamma/function.rb:57:in `initialize&#x27;
...
</code></pre><p>zip ...</p><pre><code class="hljs language-diff"><span class="hljs-comment">diff --git a/source/study/kanazawa.rb/2016-06-18/Dockerfile b/source/study/kanazawa.rb/2016-06-18/Dockerfile</span>
<span class="hljs-comment">index f9e4aff..0595f36 100644</span>
<span class="hljs-comment">--- a/source/study/kanazawa.rb/2016-06-18/Dockerfile</span>
<span class="hljs-comment">+++ b/source/study/kanazawa.rb/2016-06-18/Dockerfile</span>
<span class="hljs-meta">@@ -3,3 +3,4 @@</span> FROM ruby
COPY Gemfile /var/app/Gemfile
WORKDIR /var/app
RUN bundle install
<span class="hljs-addition">+RUN apt-get update &amp;&amp; apt-get install -y zip</span></code></pre><pre><code>$ lamma deploy test

Loading configuration.
Done.
Function &#x27;my-function-js&#x27; doesn&#x27;t seem to be exists.
Do you want to create new function &#x27;my-function-js&#x27; ? (y/n) y
Creating function &#x27;my-function-js&#x27; ...
adding: lamma.conf (deflated 17%)
adding: index.js (deflated 45%)
ArgumentError occured. You might need to specify role arn you want to pass to your function via &#x27;lamma.conf&#x27; file or ENV[&#x27;AWS_LAMBDA_IAM_ROLE&#x27;].
Done.
</code></pre><p>ほむほむ ... あんましロールを書きたくないので env で</p><pre><code>export AWS_LAMBDA_IAM_ROLE=arn:aws:iam::000000000000:role/lambda_basic_execution
</code></pre><pre><code>$ lamma deploy test

Loading configuration.
Done.
Function &#x27;my-function-js&#x27; doesn&#x27;t seem to be exists.
Do you want to create new function &#x27;my-function-js&#x27; ? (y/n) y
Creating function &#x27;my-function-js&#x27; ...
adding: lamma.conf (deflated 17%)
adding: index.js (deflated 45%)
Done.
Setting aliases.
Done.
</code></pre><pre><code>$ lamma list-functions

my-function-js
</code></pre><p>できた。</p><h2>LT 感想</h2><h3>シェルチェックを使おう</h3><ul><li>文法がバラバラなので統一する</li><li>各環境でパッケージとして提供されている</li></ul><p>確かにシェルは動かすの簡単だけど、 他の環境で動かないことが多い ...</p><h3>shUnit2 を使おう</h3><ul><li>対応シェルも幅広い</li><li>ダウンロードするだけで使える！</li></ul><p>bats 派だけど、 msys でも早いなら乗り換えたいかも</p><h3>Dokku</h3><ul><li>Heroku like</li><li>前面に nginx があって、 コンテナにルーティング</li><li>heroku の build packs も利用できるので良い！</li><li>運用メンテナンスが気になるところ</li></ul><p>スケーリングしないとかで敬遠してたけども、 開発環境で利用するなら楽だよなぁ</p><p>だいぶバージョンアップされているとのことなので、触ってみたい</p><p>もっと利用されるという話なので、その話を聞いてからかな？</p><p>dokku-alt との違いもあとで調べておこう ...</p><h3>AWSSummit</h3><p>SIer が完全に淘汰されちゃう感じ</p><p>PaaS, SaaS の流行には全然触れてなかったので、 今回の話を機会に調べてみよう ...</p><h3>Iot</h3><p>書き込むのに結構ツールが必要なんですね ...</p><p>IOT 超絶敷居高い。</p></div><div class="flex justify-end py-2"><button class="github-edit-button_githubButton__-uLd7"><a href="https://github.com/mijime/mijime.github.io/edit/master/pages/post/study/kanazawa.rb/2016/06/18/index.md">Edit</a></button></div></div></div></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{}},"page":"/post/study/kanazawa.rb/2016/06/18","query":{},"buildId":"msceCyxM1Sfkw2iHmS8tH","nextExport":true,"autoExport":true,"isFallback":false}</script><script nomodule="" src="/_next/static/chunks/polyfills-258b42e5eecc223c2582.js"></script><script src="/_next/static/chunks/main-68ca09d5e091eab3c5ab.js" async=""></script><script src="/_next/static/chunks/webpack-50bee04d1dc61f8adf5b.js" async=""></script><script src="/_next/static/chunks/framework.d2ae4074d0a54d95f68e.js" async=""></script><script src="/_next/static/chunks/commons.7394d07e57118caf40be.js" async=""></script><script src="/_next/static/chunks/pages/_app-9ecc240cedbde30f7a8f.js" async=""></script><script src="/_next/static/chunks/8d28131037b551229a39f010c44923deddaa105c.90d52ab2c7071c6500e2.js" async=""></script><script src="/_next/static/chunks/pages/post/study/kanazawa.rb/2016/06/18-af5e6c7d11738578b77b.js" async=""></script><script src="/_next/static/msceCyxM1Sfkw2iHmS8tH/_buildManifest.js" async=""></script><script src="/_next/static/msceCyxM1Sfkw2iHmS8tH/_ssgManifest.js" async=""></script></body></html>