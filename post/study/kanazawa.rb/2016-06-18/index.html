<!DOCTYPE html>
<html lang="ja">
  <head>
    <link href="http://gmpg.org/xfn/11" rel="profile">
<meta name="google-site-verification" content="7gVj5rzyozu0vYcQMLhIGr4g-WWyJn4R22RgeYqQdS0" />
<meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="generator" content="Hugo 0.59.1" />


<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">


<title> kanazawa.rb meetup 46に参加した | My snippets</title>
<meta name="description" content="AWS Lambdaを管理するツールLammaやってみた Rubyで書かれたlammbaというリポジトリが上がったので ruby勉強会に参加がてら触っ">

<meta name="keywords" content="Development,lambda,kzrb">




<link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://blog.m-iji.me/apple-touch-icon-144-precomposed.png">
<link rel="shortcut icon" href="https://blog.m-iji.me/favicon.png">



    
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.4.0/styles/zenburn.min.css" />
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.4.0/highlight.min.js" defer></script>
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/mermaid/7.0.0/mermaid.min.css" />
<script src="//cdnjs.cloudflare.com/ajax/libs/mermaid/7.0.0/mermaid.min.js" defer></script>


<link rel="stylesheet" href="https://blog.m-iji.me/css/poole.css" />
<link rel="stylesheet" href="https://blog.m-iji.me/css/syntax.css" />
<link rel="stylesheet" href="https://blog.m-iji.me/css/hyde.css" />
<link rel="stylesheet" href="https://blog.m-iji.me/css/style.css" />
<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Abril+Fatface%7COpen+Sans%7CPT+Sans" />
<link rel="stylesheet" href="//fonts.googleapis.com/earlyaccess/notosansjapanese.css" />

<script src="https://blog.m-iji.me/js/index.bundle.js" defer></script>

    
<script>
(function(i,s,o,g,r,a,m){i["GoogleAnalyticsObject"]=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,"script","//www.google-analytics.com/analytics.js","ga");

ga("create", "UA-46554348-4", "auto");
ga("send", "pageview");
</script>


  </head>
  <body class="layout-reverse">
    <header class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <h1>
        <a href="https://blog.m-iji.me/">My snippets</a>
      </h1>
      
      <p class="lead"> 何かをかく </p>
      
    </div>

    <ul class="sidebar-nav">
      <li><a href="https://blog.m-iji.me/">Home</a></li>
      
      <li><a href="/post">Posts</a></li>
      
      <li><a href="/slide">Slides</a></li>
      
      <li><a href="/tags">Tags</a></li>
      
    </ul>

    <p>&copy; 2016. All rights reserved. </p>
  </div>
</header>


<div class="content container">
  <div class="post">
    <h1 class="post-title">
      <a href="https://blog.m-iji.me/post/study/kanazawa.rb/2016-06-18/">
         kanazawa.rb meetup 46に参加した
      </a>
    </h1>
    <span class="post-date">Sat, Jun 18, 2016</span>
    <div class="post-content">
      

<span>
  
  <a href="https://blog.m-iji.me/tags/development/">#Development</a>
  
  <a href="https://blog.m-iji.me/tags/lambda/">#lambda</a>
  
  <a href="https://blog.m-iji.me/tags/kzrb/">#kzrb</a>
  
</span>


      

<h2 id="aws-lambdaを管理するツールlammaやってみた">AWS Lambdaを管理するツールLammaやってみた</h2>

<p>Rubyで書かれたlammbaというリポジトリが上がったので
ruby勉強会に参加がてら触ってみた</p>

<h3 id="lamma-https-github-com-ayemos-lamma"><a href="https://github.com/ayemos/Lamma">lamma</a></h3>

<h3 id="作業リポジトリ">作業リポジトリ</h3>

<p><a href="https://github.com/mijime/mijime.github.io/tree/content/source/study/kanazawa.rb/2016-06-18">source</a></p>

<h3 id="作業雑感">作業雑感</h3>

<p>シンプルなLambda管理ツール</p>

<h4 id="pros">Pros</h4>

<ul>
<li>1 dir,  1 funcなのでわかりやすいね</li>
<li>勝手にzipしてくれるね</li>
<li>Rubyなので今後拡張しやすい、のかな？</li>
</ul>

<h4 id="cons">Cons</h4>

<ul>
<li>nodejs, python2.7のみ対応</li>
<li>消したりするのめんどくさそう &hellip; まぁ関数だけだからいいんだけども &hellip;</li>
<li>node_modules入ってない？</li>
</ul>

<h3 id="作業ログ">作業ログ</h3>

<p>まずは環境作成</p>

<pre><code class="language-ruby">source &quot;https://rubygems.org&quot;

gem &quot;lamma&quot;
</code></pre>

<pre><code>FROM ruby

COPY Gemfile /var/app/Gemfile
WORKDIR /var/app
RUN bundle install
</code></pre>

<pre><code>---
version: '2'
services:
  app:
    build: .
    command: sleep 3600
    environment:
      AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID}
      AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY}
    volumes:
      - ./scripts:/var/app/scripts
</code></pre>

<p>とりあえずインストールして実行してみる</p>

<p>AWS関連の情報を渡して &hellip;</p>

<pre><code>eval $(cat ~/.aws/credentials | awk -v FS=&quot; = &quot; '$1~/^aws/{print &quot;export&quot;,toupper($1)&quot;=&quot;$2}')
</code></pre>

<p>関数を作成してみる</p>

<pre><code>lamma create scripts/my-function-1 --runtime python2.7

Creating function at directory ./scripts/my-function-1.
bundler: failed to load command: lamma (/usr/local/bundle/bin/lamma)
NoMethodError: undefined method `match' for nil:NilClass
Did you mean?  catch
/usr/local/bundle/gems/aws-sdk-core-2.3.14/lib/aws-sdk-core/endpoint_provider.rb:67:in `block in partition_matching_region'
/usr/local/bundle/gems/aws-sdk-core-2.3.14/lib/aws-sdk-core/endpoint_provider.rb:66:in `each'
/usr/local/bundle/gems/aws-sdk-core-2.3.14/lib/aws-sdk-core/endpoint_provider.rb:66:in `find'
/usr/local/bundle/gems/aws-sdk-core-2.3.14/lib/aws-sdk-core/endpoint_provider.rb:66:in `partition_matching_region'
...
</code></pre>

<p>うーん &hellip;  なぜにnil &hellip;</p>

<p>AWS_REGIONを渡す</p>

<pre><code class="language-diff">diff --git a/source/study/kanazawa.rb/2016-06-18/docker-compose.yml b/source/study/kanazawa.rb/2016-06-18/docker-compose.yml
index e03b010..2784d3c 100644
--- a/source/study/kanazawa.rb/2016-06-18/docker-compose.yml
+++ b/source/study/kanazawa.rb/2016-06-18/docker-compose.yml
@@ -7,5 +7,6 @@ services:
     environment:
       AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID}
       AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY}
+      AWS_REGION: ap-northeast-1
     volumes:
       - ./scripts:/var/app/scripts
</code></pre>

<pre><code>$ lamma create my-function --runtime python2.7

Creating function at directory ./my-function.
Done.
</code></pre>

<pre><code>$ tree .

my-function
  ├── lambda_function.py
  └── lamma.conf

1 directory, 2 files
</code></pre>

<p>まだこの時点で関数は作られていないみたい &hellip;  なんでAWS認証求められたんだ</p>

<p>deployしてみる。</p>

<pre><code>$ lamma deploy test

Loading configuration.
Done.
bundler: failed to load command: lamma (/usr/local/bundle/bin/lamma)
Aws::Lambda::Errors::BadRequest:
/usr/local/bundle/gems/aws-sdk-core-2.3.14/lib/seahorse/client/plugins/raise_response_errors.rb:15:in `call'
/usr/local/bundle/gems/aws-sdk-core-2.3.14/lib/aws-sdk-core/plugins/param_converter.rb:20:in `call'
/usr/local/bundle/gems/aws-sdk-core-2.3.14/lib/seahorse/client/plugins/response_target.rb:21:in `call'
</code></pre>

<p>うーん &hellip;  ?</p>

<p>よくわからないのでJSで作り直す</p>

<pre><code>$ lamma create my-function-js --runtime nodejs

Creating function at directory ./my-function-js.
Done.
</code></pre>

<pre><code>$ lamma deploy test

Loading configuration.
Done.
Function 'my-function-js' doesn't seem to be exists.
Do you want to create new function 'my-function-js' ? (y/n) y
Creating function 'my-function-js' ...
bundler: failed to load command: lamma (/usr/local/bundle/bin/lamma)
Errno::ENOENT: No such file or directory @ rb_sysopen - /tmp/d20160618-92-1fppw7/lambda.zip
  /usr/local/bundle/gems/lamma-0.1.1/lib/lamma/function.rb:57:in `initialize'
...
</code></pre>

<p>zip &hellip;</p>

<pre><code class="language-diff">diff --git a/source/study/kanazawa.rb/2016-06-18/Dockerfile b/source/study/kanazawa.rb/2016-06-18/Dockerfile
index f9e4aff..0595f36 100644
--- a/source/study/kanazawa.rb/2016-06-18/Dockerfile
+++ b/source/study/kanazawa.rb/2016-06-18/Dockerfile
@@ -3,3 +3,4 @@ FROM ruby
COPY Gemfile /var/app/Gemfile
WORKDIR /var/app
RUN bundle install
+RUN apt-get update &amp;&amp; apt-get install -y zip
</code></pre>

<pre><code>$ lamma deploy test

Loading configuration.
Done.
Function 'my-function-js' doesn't seem to be exists.
Do you want to create new function 'my-function-js' ? (y/n) y
Creating function 'my-function-js' ...
adding: lamma.conf (deflated 17%)
adding: index.js (deflated 45%)
ArgumentError occured. You might need to specify role arn you want to pass to your function via 'lamma.conf' file or ENV['AWS_LAMBDA_IAM_ROLE'].
Done.
</code></pre>

<p>ほむほむ &hellip; あんましロールを書きたくないのでenvで</p>

<pre><code>export AWS_LAMBDA_IAM_ROLE=arn:aws:iam::000000000000:role/lambda_basic_execution
</code></pre>

<pre><code>$ lamma deploy test

Loading configuration.
Done.
Function 'my-function-js' doesn't seem to be exists.
Do you want to create new function 'my-function-js' ? (y/n) y
Creating function 'my-function-js' ...
adding: lamma.conf (deflated 17%)
adding: index.js (deflated 45%)
Done.
Setting aliases.
Done.
</code></pre>

<pre><code>$ lamma list-functions

my-function-js
</code></pre>

<p>できた。</p>

<h2 id="lt感想">LT感想</h2>

<h3 id="シェルチェックを使おう">シェルチェックを使おう</h3>

<ul>
<li>文法がバラバラなので統一する</li>
<li>各環境でパッケージとして提供されている</li>
</ul>

<p>確かにシェルは動かすの簡単だけど、 他の環境で動かないことが多い &hellip;</p>

<h3 id="shunit2を使おう">shUnit2を使おう</h3>

<ul>
<li>対応シェルも幅広い</li>
<li>ダウンロードするだけで使える！</li>
</ul>

<p>bats派だけど、 msysでも早いなら乗り換えたいかも</p>

<h3 id="dokku">Dokku</h3>

<ul>
<li>Heroku like</li>
<li>前面にnginxがあって、 コンテナにルーティング</li>
<li>herokuのbuild packsも利用できるので良い！</li>
<li>運用メンテナンスが気になるところ</li>
</ul>

<p>スケーリングしないとかで敬遠してたけども、 開発環境で利用するなら楽だよなぁ</p>

<p>だいぶバージョンアップされているとのことなので、触ってみたい</p>

<p>もっと利用されるという話なので、その話を聞いてからかな？</p>

<p>dokku-altとの違いもあとで調べておこう &hellip;</p>

<h3 id="awssummit">AWSSummit</h3>

<p>SIerが完全に淘汰されちゃう感じ</p>

<p>PaaS, SaaSの流行には全然触れてなかったので、 今回の話を機会に調べてみよう &hellip;</p>

<h3 id="iot">Iot</h3>

<p>書き込むのに結構ツールが必要なんですね &hellip;</p>

<p>IOT超絶敷居高い。</p>

    </div>
  </div>
</div>

  </body>
</html>
